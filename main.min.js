var a='video';var b=document.getElementById('videoPlayer');var c='div#vid-overlay';var d='#vidAnnotation';var e='div.annotation-on-screen';var f='a#addAnnotation';var g='a.removeAnnotation';var h='a#playPauseButton';var i='progress#progress';var j='div#informationalText';var k='a#volume-down';var l='a#volume-up';var m='a#hidey-showy';var n='a#delete-everything-button';var o='a#toggle-annotations-button';var p='span#play-time';var q='#addAnnotationForm';var r='a#saveAddForm';var s='a#cancelAddForm';var t='#form-annotation-text';var u='#form-annotation-length';var v='#form-annotation-link';var w='canvas';var x='form#videoURL';var y='a#change-video-button';var z='#videoURLSubmit';var A='#form-video-URL';var B='#form-image-url';var C='#textTab';var D='#imageTab';var E='#textTabContent';var F='#imageTabContent';var G='#form-remove-whitespace';var H="#background-colour-button";var I="#text-colour-button";var J="rgba(89, 124, 86, 0.7)";var K="rgba(255, 255, 255, 1.0)";var L=400;var M=220;var N=600;var O=330;var P=0.55;var Q=1.5;var R=document.getElementById('vid-canvas');var S=R.getContext('2d');var T=L;var U=M;var V={};var W=false;var X=false;var Y=0;var Z=[];var ab=false;var ac=false;var ad=true;var ae=3000;var af=false;var ag=1;var ah=16;function ai(a,b,c,d,e,f,g,h,i,j,k,l){this.textString=a;this.imageUrl=b;this.xPosition=c;this.yPosition=d;this.aWidth=e;this.aHeight=f;this.startTime=g;this.endTime=h;this.zIndex=i;this.backgroundColour=j;this.textColour=k;this.link=l;}function aj(a){var b=(String(a.startTime))+(String(a.endTime))+(String(a.xPosition))+(String(a.yPosition))+(String(a.text));var c=CryptoJS.MD5(b);return c.toString();}function ak(a){var b=new ai(a,null,30,30,30,30,3,5,3000,J,K,null);Z.push(b);}function al(a){if(!ad)return;var b=aj(a);var d='';if(a.link!=null&&a.link.length>0)d=a.link;var e='<div class="annotation-on-screen" data-easyannotation-annotation-href="'+d+'" title="'+d+'" id="'+b+'"></div>';var f='div#'+b;$(c).append(e);var g=a.aHeight;if(g<20)g=20;var h=a.aWidth;if(h<30)h=30;h=(h*T/L);g=(g*T/L);var i=(a.xPosition*T/L);var j=(a.yPosition*T/L);var k=((T*P)-j);var l=(T-i);var m=J;if(a.backgroundColour)m=a.backgroundColour;var n=K;if(n!=null)n=a.textColour;$(f).css({"width":h,"height":g,"position":"absolute","padding":"5px","overflow":"auto","top":j,"left":i,"max-width":l,"max-height":k,"z-index":a.zIndex,"background-color":m,"color":n});$(f).addClass('no-select');var o=a.textString;if(o==null)o="";o='<p>'+o+'</p>';$(f).html(o);if(a.imageUrl!=null){var p='<img src="'+a.imageUrl+'"/>';$(f).append(p);var q=f+' img';$(q).css({"width":"100%","height":"auto"});}}function am(a){var b=aj(a);var c='div#'+b;$(c).remove();}function an(){$(p).text(aA(Y));if(af){$(e).remove();ao();af=false;return;}var a=$.grep(Z,function(a){return(Y>=a.startTime&&Y<a.endTime);});var b=$.grep(Z,function(a){return(Y==a.startTime);});if(b!=null)if(b.length>0)for(var c=0;c<b.length;c++){var d=b[c];al(d);}var f=$.grep(Z,function(a){return(Y==a.endTime);});if(f!=null)if(f.length>0)for(var c=0;c<f.length;c++)am(f[c]);}function ao(){var a=$.grep(Z,function(a){return(Y>=a.startTime&&Y<a.endTime);});if(a!=null)if(a.length>0)for(var b=0;b<a.length;b++){var c=a[b];al(c);}}function ap(){if(localStorage.getItem('easyannotate-video-url')){var c=localStorage.getItem('easyannotate-video-url');$(b).find('#MP4-video').attr('src',c);$(b).bind("loadedmetadata",function(){var a=this.videoWidth;var c=this.videoHeight;if((a/c)>1.818){var d=T;$(b).width(d);}else{var e=U;$(b).height(e);}});b.load();b.currentTime=0;}if(localStorage.getItem('easyannotate-video-id')){var d=localStorage.getItem('easyannotate-video-id');$(b).attr('data-easyannotation-file-id',d);}var e=$(a).attr('data-easyannotation-file-id');if(localStorage.getItem(e)){var f=JSON.parse(localStorage.getItem(e));if(f==null)Z=[];else Z=f;}else Z=[];$(a).controls=false;Z.sort(function(a,b){return a.startTime-b.startTime;});aD();aH();}function aq(){var b=JSON.stringify(Z);var c=$(a).data('easyannotation-file-id');localStorage.setItem(c,b);}function ar(){var b=$(a).data('easyannotation-file-id');localStorage.setItem(b,null);Z=[];}function as(){window.localStorage.clear();Z=[];}function at(){$(f).fadeTo("fast",0);$(w).css('z-index',5000);X=true;$(a).trigger('pause');$(j).text("Begin drawing over the video...(press escape to exit)");}function au(){S.clearRect(0,0,R.width,R.height);X=false;$(j).text("");aM();$(w).css('z-index',2000);}function av(){var a=$(t).val();var b=$(v).val();if(b!=null&&b.length>0)if(aC(b)||b.length<4){}else{alert('Invalid link URL! Please check and try again...');return;}else b=null;var c=$(u).val();var d=$(B).val();var e=$(G).val();if(d!=null&&d.length>0)if(aC(d)||d.length<4)a=' ';else{alert('Invalid image URL! Please check and try again...');return;}else d=null;$(f).fadeTo("fast",1);aM();ax();if(c==null||isNaN(c))c="2";var g=V.startX;var h=V.startY;var i=V.w;var j=V.h;if(ab){g=(g/Q);h=(h/Q);i=(i/Q);j=(j/Q);}if(j<20)j=20;if(i<30)i=30;if(e)j='auto';if(g+i>(L-10))g=390-i;if(h+j>((L*P)-10))h=210-j;var k=$(H).css("background-color");var l=$(I).css("background-color");if(a!=null&&a.length>0){var m=new ai(a,d,g,h,i,j,Y,(Y+parseInt(c)),ae,k,l,b);Z.push(m);aq();aD();ae=ae+1;}else alert("An annotation title is required - please enter one.");}function aw(){var a=$(A).val();if(!aC(a)){alert("It looks like you've entered an invalid video URL... please check it over then try again.");return false;}var b=CryptoJS.MD5(a);aN();localStorage.setItem('easyannotate-video-url',a);localStorage.setItem('easyannotate-video-id',b);Z=[];aD();ap();}function ax(){$(t).val("");$(v).val("");$(B).val("");$(u).val("2");}function ay(){aM();ax();$(f).fadeTo("fast",1);}function az(){if(b.paused||b.ended){b.play();$(h).html('<i class="fa fa-pause"></i>');}else{b.pause();$(h).html('<i class="fa fa-play"></i>');}}function aA(a){var b=Math.floor(a/60);var c=a-(b*60);if(c<10)c="0"+String(c);if(a<10)return "0:0"+String(a);if(a<60)return "0:"+String(a);return String(b)+":"+String(c);}function aB(){var a=document.getElementById('progress');var c=Math.floor((100/b.duration)*(b.currentTime));a.value=c;a.innerHTML=c+"%";}function aC(a){if(/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(a))return true;else return false;}function aD(){Z.sort(function(a,b){return a.startTime-b.startTime;});$("li.vidAnnotationListItem").each(function(a){this.remove();});for(var a=0;a<Z.length;a++){var b=Z[a];var c='Text annotation';var e='';if(b.imageUrl!=null){c='Image annotation';e='<img style="width: 100%; height: auto; margin-top: 5px;" src="'+b.imageUrl+'"/>';}var f='';var g='';if(b.link!=null){if(b.link.length>35)g=b.link.substring(0,32)+"...";else g=b.link;f='<div class="annotationLink" title="'+b.link+'"><a href="'+b.link+'" target="_blank"><i class="fa fa-link"></i>&nbsp;'+g+'</a></div>';}var h='<li class="vidAnnotationListItem" style="background-color: '+b.backgroundColour+';" ><a class="removeAnnotation" href="#" data-easyannotation-annotation-id="'+a+'">X</a><div class="vidAnnotationType">'+c+'</div><div class="vidAnnotationTimes">'+aA(b.startTime)+' - '+aA(b.endTime)+'</div><div class="vidAnnotationContent" style="color: '+b.textColour+';">'+e+b.textString+'</div>'+f+'</li>';$("ul#vidAnnotationList").append(h);}if(Z.length>0)$(d).css({'background-image':"none"});else $(d).css({'background-image':"url('resources/noAnnotations.png')"});}function aE(){$("li.vidAnnotationListItem").each(function(){this.remove();});}function aF(a){var b=Z[a];am(b);Z.splice(a,1);aD();aq();}function aG(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top};}function aH(){R.addEventListener('mousedown',aI,false);R.addEventListener('mouseup',aJ,false);R.addEventListener('mousemove',aK,false);}function aI(a){if(X){V.startX=aG(R,a).x;V.startY=aG(R,a).y;W=true;}}function aJ(){if(!X)return;W=false;au();}function aK(a){if(W&&X){V.w=aG(R,a).x-V.startX;V.h=aG(R,a).y-V.startY;S.clearRect(0,0,R.width,R.height);aL();}}function aL(){if(X){S.fillStyle=J;S.fillRect(V.startX,V.startY,V.w,V.h);}}function aM(){if(ac){$(q).hide();$('#vidTitle').css('margin-top','14px');ac=false;}else{$(q).show();$('#vidTitle').css('margin-top','-200px');$(H).attr('value',J);$(I).attr('value',K);$(H).colorPicker();$(I).colorPicker();ac=true;}}function aN(){if($(x).is(":visible"))$(x).hide("fast");else $(x).show("fast");}$(document).ready(function(){ap();$(q).hide();$(F).hide();$(x).hide();$(a).bind('play',function(){an();$(h).html('<i class="fa fa-pause"></i>');});$(a).bind('pause',function(){$(h).html('<i class="fa fa-play"></i>');});$(a).bind('ended',function(){Y=0;document.getElementById('progress').value=0;$(h).html('<i class="fa fa-play"></i>');$(e).remove();});$(a).bind('timeupdate',function(){aB();var a=Math.floor(this.currentTime);if(a!=Y){Y=a;an();}});$(f).click(function(){at();});$(r).click(function(){av();});$(s).click(function(){ay();});$(h).click(function(){az();});$(z).click(function(){aw();});$(document).on('click',g,function(){var a=$(this).data('easyannotation-annotation-id');aF(a);});$(document).on('click',e,function(){var a=$(this).data('easyannotation-annotation-href');if(a.length>1){if(!b.paused)$(h).trigger('click');window.open(a,'_blank');}});$(l).click(function(){if(b.volume==1)return;b.volume+=0.1;});$(k).click(function(){if(b.volume==0)return;b.volume-=0.1;});$(n).click(function(){var a=confirm('This will delete all annotations, do you wish to continue?');if(a){ar();aq();aD();$(e).remove();}});$(y).click(function(){aN();});$(C).click(function(){$(E).show();$(F).hide();$(C).addClass("selected");$(D).removeClass("selected");ag=1;});$(D).click(function(){$(F).show();$(E).hide();$(D).addClass("selected");$(C).removeClass("selected");ag=2;});$(m).click(function(){if(ab){$(a).animate({"width":(L+"px")},function(){$(d).show();});$(this).text("Hide Annotation List");ab=false;T=L;U=M;R.width=L;R.height=(L*P);var b=0.666;ah=ah*b;$('.annotation-on-screen').each(function(a,c){var d=$(this).width();var e=$(this).height();var f=$(this).position().left;var g=$(this).position().top;var h=d*b;var i=e*b;var j=f*b;var k=g*b;$(this).animate({width:h+'px',height:i+'px',left:j+'px',top:k+'px'});});$('#vid').animate({height:'223px'});$(q).animate({"top":"330px"});}else{$(a).animate({"width":"600px"});$(d).hide();$(this).text("Show Annotation List");ab=true;T=N;U=O;R.width=N;R.height=(N*P);ah=ah*Q;$('.annotation-on-screen').each(function(a,b){var c=$(this).width();var d=$(this).height();var e=$(this).position().left;var f=$(this).position().top;var g=c*Q;var h=d*Q;var i=e*Q;var j=f*Q;$(this).animate({width:g+'px',height:h+'px',left:i+'px',top:j+'px'});$(this).css('font-size',ah+'px');});$('#vid').animate({height:'333px'});$(q).animate({"top":"440px"});}});$(o).click(function(){if(ad){ad=false;$(this).text("Turn on annotations");$(e).remove();}else{ad=true;$(this).text("Turn off annotations");ao();}});$(i).bind('click',function(a){var c=$(i).offset().left;var d=a.clientX-c;var e=((d/b.duration)/2);if(e>=0&&e<=b.duration){af=true;b.currentTime=e;}});Mousetrap.bind('space',function(){$(h).trigger('click');});Mousetrap.bind('up',function(){$(l).trigger('click');});Mousetrap.bind('down',function(){$(k).trigger('click');});Mousetrap.bind('n',function(){at();});Mousetrap.bind('h',function(){$(m).trigger('click');});Mousetrap.bind('a',function(){$(o).trigger('click');});Mousetrap.bind('c',function(){$(y).trigger('click');});Mousetrap.bind('esc',function(){if(X==true){X=false;$(j).text('');$(f).fadeTo("fast",1);}else if($(q).is(':visible'))ay();});});