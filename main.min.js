var a='video';var b=document.getElementById('videoPlayer');var c='div#vid-overlay';var d='#vidAnnotation';var e='div.annotation-on-screen';var f='a#addAnnotation';var g='a.removeAnnotation';var h='a#playPauseButton';var i='progress#progress';var j='div#informationalText';var k='a#volume-down';var l='a#volume-up';var m='a#hidey-showy';var n='a#delete-everything-button';var o='a#toggle-annotations-button';var p='span#play-time';var q='#addAnnotationForm';var r='a#saveAddForm';var s='a#cancelAddForm';var t='#form-annotation-text';var u='#form-annotation-length';var v='#form-annotation-link';var w='canvas';var x='form#videoURL';var y='a#change-video-button';var z='#videoURLSubmit';var A='#form-video-URL';var B='#form-image-url';var C='#textTab';var D='#imageTab';var E='#textTabContent';var F='#imageTabContent';var G='#form-remove-whitespace';var H='#form-remove-image-whitespace';var I="#background-colour-button";var J="#text-colour-button";var K="rgba(89, 124, 86, 0.7)";var L="rgba(255, 255, 255, 1.0)";var M=400;var N=220;var O=600;var P=330;var Q=0.55;var R=1.5;var S=document.getElementById('vid-canvas');var T=S.getContext('2d');var U=M;var V=N;var W={};var X=false;var Y=false;var Z=0;var ab=[];var ac=false;var ad=false;var ae=true;var af=3000;var ag=false;var ah=1;var ai=16;function aj(a,b,c,d,e,f,g,h,i,j,k,l){this.textString=a;this.imageUrl=b;this.xPosition=c;this.yPosition=d;this.aWidth=e;this.aHeight=f;this.startTime=g;this.endTime=h;this.zIndex=i;this.backgroundColour=j;this.textColour=k;this.link=l;}function ak(a){var b=(String(a.startTime))+(String(a.endTime))+(String(a.xPosition))+(String(a.yPosition))+(String(a.text));var c=CryptoJS.MD5(b);return c.toString();}function al(a){var b=new aj(a,null,30,30,30,30,3,5,3000,K,L,null);ab.push(b);}function am(a){if(!ae)return;var b=ak(a);var d='';if(a.link!=null&&a.link.length>0)d=a.link;var e='<div class="annotation-on-screen" data-easyannotation-annotation-href="'+d+'" title="'+d+'" id="'+b+'"></div>';var f='div#'+b;$(c).append(e);var g=a.aHeight;if(g<20)g=20;var h=a.aWidth;if(h<30)h=30;h=(h*U/M);g=(g*U/M);var i=(a.xPosition*U/M);var j=(a.yPosition*U/M);var k=((U*Q)-j);var l=(U-i);var m=K;if(a.backgroundColour)m=a.backgroundColour;var n=L;if(n!=null)n=a.textColour;$(f).css({"width":h,"height":g,"position":"absolute","padding":"5px","overflow":"auto","top":j,"left":i,"max-width":l,"max-height":k,"z-index":a.zIndex,"background-color":m,"color":n});$(f).addClass('no-select');var o=a.textString;if(o==null)o="";o='<p>'+o+'</p>';$(f).html(o);if(a.imageUrl!=null){var p='<img src="'+a.imageUrl+'"/>';$(f).append(p);var q=f+' img';$(q).css({"width":"100%","height":"auto"});}}function an(a){var b=ak(a);var c='div#'+b;$(c).remove();}function ao(){$(p).text(aB(Z));if(ag){$(e).remove();ap();ag=false;return;}var a=$.grep(ab,function(a){return(Z>=a.startTime&&Z<a.endTime);});var b=$.grep(ab,function(a){return(Z==a.startTime);});if(b!=null)if(b.length>0)for(var c=0;c<b.length;c++){var d=b[c];am(d);}var f=$.grep(ab,function(a){return(Z==a.endTime);});if(f!=null)if(f.length>0)for(var c=0;c<f.length;c++)an(f[c]);}function ap(){var a=$.grep(ab,function(a){return(Z>=a.startTime&&Z<a.endTime);});if(a!=null)if(a.length>0)for(var b=0;b<a.length;b++){var c=a[b];am(c);}}function aq(){if(localStorage.getItem('easyannotate-video-url')){var c=localStorage.getItem('easyannotate-video-url');$(b).find('#MP4-video').attr('src',c);$(b).bind("loadedmetadata",function(){var a=this.videoWidth;var c=this.videoHeight;if((a/c)>1.818)$(b).width(U);else $(b).height(V);});b.load();b.currentTime=0;}if(localStorage.getItem('easyannotate-video-id')){var d=localStorage.getItem('easyannotate-video-id');$(b).attr('data-easyannotation-file-id',d);}var e=$(a).attr('data-easyannotation-file-id');if(localStorage.getItem(e)){var f=JSON.parse(localStorage.getItem(e));if(f==null)ab=[];else ab=f;}else ab=[];$(a).controls=false;ab.sort(function(a,b){return a.startTime-b.startTime;});aE();aH();}function ar(){var b=JSON.stringify(ab);var c=$(a).data('easyannotation-file-id');localStorage.setItem(c,b);}function as(){var b=$(a).data('easyannotation-file-id');localStorage.setItem(b,null);ab=[];}function at(){window.localStorage.clear();ab=[];}function au(){$(f).fadeTo("fast",0);$(w).css('z-index',5000);Y=true;$(a).trigger('pause');$(j).text("Begin drawing over the video...(press escape to exit)");}function av(){T.clearRect(0,0,S.width,S.height);Y=false;$(j).text("");aM();$(w).css('z-index',2000);}function aw(){var a=$(t).val();var b=$(v).val();if(b!=null&&b.length>0)if(aD(b)||b.length<4){}else{alert('Invalid link URL! Please check and try again...');return;}else b=null;var c=$(u).val();var d=$(B).val();var e=$(G).val();var g=$(H).val();if(d!=null&&d.length>0)if(aD(d)||d.length<4)a=' ';else{alert('Invalid image URL! Please check and try again...');return;}else d=null;$(f).fadeTo("fast",1);aM();ay();if(c==null||isNaN(c))c="2";var h=W.startX;var i=W.startY;var j=W.w;var k=W.h;if(ac){h=(h/R);i=(i/R);j=(j/R);k=(k/R);}if(k<20)k=20;if(j<30)j=30;if(e||g)k='auto';if(h+j>(M-10))h=390-j;if(i+k>((M*Q)-10))i=210-k;var l=$(I).css("background-color");var m=$(J).css("background-color");if(a!=null&&a.length>0){var n=new aj(a,d,h,i,j,k,Z,(Z+parseInt(c)),af,l,m,b);ab.push(n);ar();aE();af=af+1;}else alert("An annotation title is required - please enter one.");}function ax(){var a=$(A).val();if(!aD(a)){alert("It looks like you've entered an invalid video URL... please check it over then try again.");return false;}var b=CryptoJS.MD5(a);aN();localStorage.setItem('easyannotate-video-url',a);localStorage.setItem('easyannotate-video-id',b);ab=[];aE();aq();}function ay(){$(t).val("");$(v).val("");$(B).val("");$(u).val("2");}function az(){aM();ay();$(f).fadeTo("fast",1);}function aA(){if(b.paused||b.ended){b.play();$(h).html('<i class="fa fa-pause"></i>');}else{b.pause();$(h).html('<i class="fa fa-play"></i>');}}function aB(a){var b=Math.floor(a/60);var c=a-(b*60);if(c<10)c="0"+String(c);if(a<10)return "0:0"+String(a);if(a<60)return "0:"+String(a);return String(b)+":"+String(c);}function aC(){var a=document.getElementById('progress');var c=Math.floor((100/b.duration)*(b.currentTime));a.value=c;a.innerHTML=c+"%";}function aD(a){return !!/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(a);}function aE(){ab.sort(function(a,b){return a.startTime-b.startTime;});$("li.vidAnnotationListItem").each(function(){this.remove();});for(var a=0;a<ab.length;a++){var b=ab[a];var c='Text annotation';var e='';if(b.imageUrl!=null){c='Image annotation';e='<img style="width: 100%; height: auto; margin-top: 5px;" src="'+b.imageUrl+'"/>';}var f='';var g='';if(b.link!=null){if(b.link.length>35)g=b.link.substring(0,32)+"...";else g=b.link;f='<div class="annotationLink" title="'+b.link+'"><a href="'+b.link+'" target="_blank"><i class="fa fa-link"></i>&nbsp;'+g+'</a></div>';}var h='<li class="vidAnnotationListItem" style="background-color: '+b.backgroundColour+';" ><a class="removeAnnotation" href="#" data-easyannotation-annotation-id="'+a+'">X</a><div class="vidAnnotationType">'+c+'</div><div class="vidAnnotationTimes">'+aB(b.startTime)+' - '+aB(b.endTime)+'</div><div class="vidAnnotationContent" style="color: '+b.textColour+';">'+e+b.textString+'</div>'+f+'</li>';$("ul#vidAnnotationList").append(h);}if(ab.length>0)$(d).css({'background-image':"none"});else $(d).css({'background-image':"url('resources/noAnnotations.png')"});}function aF(a){var b=ab[a];an(b);ab.splice(a,1);aE();ar();}function aG(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top};}function aH(){S.addEventListener('mousedown',aI,false);S.addEventListener('mouseup',aJ,false);S.addEventListener('mousemove',aK,false);}function aI(a){if(Y){W.startX=aG(S,a).x;W.startY=aG(S,a).y;X=true;}}function aJ(){if(!Y)return;X=false;av();}function aK(a){if(X&&Y){W.w=aG(S,a).x-W.startX;W.h=aG(S,a).y-W.startY;T.clearRect(0,0,S.width,S.height);aL();}}function aL(){if(Y){T.fillStyle=K;T.fillRect(W.startX,W.startY,W.w,W.h);}}function aM(){if(ad){$(q).hide();$('#vidTitle').css('margin-top','14px');ad=false;}else{$(q).show();$('#vidTitle').css('margin-top','-200px');$(I).attr('value',K);$(J).attr('value',L);$(I).colorPicker();$(J).colorPicker();ad=true;}}function aN(){if($(x).is(":visible"))$(x).hide("fast");else $(x).show("fast");}$(document).ready(function(){aq();$(q).hide();$(F).hide();$(x).hide();$(a).bind('play',function(){ao();$(h).html('<i class="fa fa-pause"></i>');});$(a).bind('pause',function(){$(h).html('<i class="fa fa-play"></i>');});$(a).bind('ended',function(){Z=0;document.getElementById('progress').value=0;$(h).html('<i class="fa fa-play"></i>');$(e).remove();});$(a).bind('timeupdate',function(){aC();var a=Math.floor(this.currentTime);if(a!=Z){Z=a;ao();}});$(f).click(function(){au();});$(r).click(function(){aw();});$(s).click(function(){az();});$(h).click(function(){aA();});$(z).click(function(){ax();});$(document).on('click',g,function(){var a=$(this).data('easyannotation-annotation-id');aF(a);});$(document).on('click',e,function(){var a=$(this).data('easyannotation-annotation-href');if(a.length>1){if(!b.paused)$(h).trigger('click');window.open(a,'_blank');}});$(l).click(function(){if(b.volume==1)return;b.volume+=0.1;});$(k).click(function(){if(b.volume==0)return;b.volume-=0.1;});$(n).click(function(){var a=confirm('This will delete all annotations, do you wish to continue?');if(a){as();ar();aE();$(e).remove();}});$(y).click(function(){aN();});$(C).click(function(){$(E).show();$(F).hide();$(C).addClass("selected");$(D).removeClass("selected");ah=1;});$(D).click(function(){$(F).show();$(E).hide();$(D).addClass("selected");$(C).removeClass("selected");ah=2;});$(m).click(function(){if(ac){$(a).animate({"width":(M+"px")},function(){$(d).show();});$(this).text("Hide Annotation List");ac=false;U=M;V=N;S.width=M;S.height=(M*Q);var b=0.666;ai=ai*b;$('.annotation-on-screen').each(function(){var a=$(this).width();var c=$(this).height();var d=$(this).position().left;var e=$(this).position().top;var f=a*b;var g=c*b;var h=d*b;var i=e*b;$(this).animate({width:f+'px',height:g+'px',left:h+'px',top:i+'px'});});$('#vid').animate({height:'223px'});$(q).animate({"top":"350px"});}else{$(a).animate({"width":"600px"});$(d).hide();$(this).text("Show Annotation List");ac=true;U=O;V=P;S.width=O;S.height=(O*Q);ai=ai*R;$('.annotation-on-screen').each(function(){var a=$(this).width();var b=$(this).height();var c=$(this).position().left;var d=$(this).position().top;var e=a*R;var f=b*R;var g=c*R;var h=d*R;$(this).animate({width:e+'px',height:f+'px',left:g+'px',top:h+'px'});$(this).css('font-size',ai+'px');});$('#vid').animate({height:'333px'});$(q).animate({"top":"460px"});}});$(o).click(function(){if(ae){ae=false;$(this).text("Turn on annotations");$(e).remove();}else{ae=true;$(this).text("Turn off annotations");ap();}});$(i).bind('click',function(a){var c=$(i).offset().left;var d=a.clientX-c;var e=((d/b.duration)/2);if(e>=0&&e<=b.duration){ag=true;b.currentTime=e;}});Mousetrap.bind('space',function(){$(h).trigger('click');});Mousetrap.bind('up',function(){$(l).trigger('click');});Mousetrap.bind('down',function(){$(k).trigger('click');});Mousetrap.bind('n',function(){au();});Mousetrap.bind('h',function(){$(m).trigger('click');});Mousetrap.bind('a',function(){$(o).trigger('click');});Mousetrap.bind('c',function(){$(y).trigger('click');});Mousetrap.bind('esc',function(){if(Y==true){Y=false;$(j).text('');$(f).fadeTo("fast",1);}else if($(q).is(':visible'))az();});});