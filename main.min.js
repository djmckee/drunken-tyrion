var a='video';var b=document.getElementById('videoPlayer');var c='div#vid-overlay';var d='#vidAnnotation';var e='a#addAnnotation';var f='a.removeAnnotation';var g='a#playPauseButton';var h='progress#progress';var i='div#informationalText';var j='a#volume-down';var k='a#volume-up';var l='a#hidey-showy';var m='a#delete-everything-button';var n='a#toggle-annotations-button';var o='span#play-time';var p='a#saveAddForm';var q='a#cancelAddForm';var r='#form-annotation-text';var s='#form-annotation-length';var t=document.getElementById('vid-canvas');var u=t.getContext('2d');var v=400;var w={};var x=false;var y=false;var z=0;var A=[];var B=false;var C=false;var D=true;var E=3000;var F=['red','green','blue'];var G=0;function H(a,b,c,d,e,f,g,h,i){this.textString=a;this.imageUrl=b;this.xPosition=c;this.yPosition=d;this.aWidth=e;this.aHeight=f;this.startTime=g;this.endTime=h;this.zIndex=i;}function I(a){var b=(String(a.startTime))+(String(a.endTime))+(String(a.xPosition))+(String(a.yPosition))+(a.text);var c=CryptoJS.MD5(b);return c.toString();}function J(a){var b=new H(a,null,30,30,30,30,3,5,3000);A.push(b);console.log(A);}function K(a){if(!D)return;var b=I(a);var d='<div class="annotation-on-screen" id="'+b+'"></div>';var e='div#'+b;$(c).append(d);console.log('attempting to add:'+d);var f=a.aHeight;if(f<20)f=20;var g=a.aWidth;if(g<30)g=30;if(F[G]=='red')var h="rgba(255, 38, 0, 0.7)";else if(F[G]=='green')var h="rgba(89, 124, 86, 0.7)";else if(F[G]=='blue')var h="rgba(3, 58, 255, 0.7)";$(e).css({"width":(g*v/400),"height":(f*v/400),"position":"absolute","top":(a.yPosition*v/400),"left":(a.xPosition*v/400),"z-index":a.zIndex,"background-color":h});var i=a.textString;console.log('annotation title: '+i);if(i==null)i="";$(e).text(i);if(a.imageUrl!=null){var j='<img src="'+a.imageUrl+'"/>';$(e).append(j);var k=e+' img';$(k).css({"width":"100%","height":"auto"});}if(G<2)G=G+1;else G=0;}function L(a){var b=I(a);var c='div#'+b;$(c).remove();}function M(){console.log('update called.');$(o).text(W(z));var a=$.grep(A,function(a){return(z>=a.startTime&&z<a.endTime);});var b=$.grep(A,function(a){return(z==a.startTime);});if(b!=null)if(b.length>0){console.log('have new annotations to load');for(var c=0;c<b.length;c++){console.log('need to add something.');var d=b[c];console.log(d);K(d);}}var e=$.grep(A,function(a){return(z==a.endTime);});if(e!=null)if(e.length>0){console.log('have old annotations to remove');for(var c=0;c<e.length;c++){console.log('need to remove something.');L(e[c]);}}console.log(a);}function N(){var a=$.grep(A,function(a){return(z>=a.startTime&&z<a.endTime);});if(a!=null)if(a.length>0){console.log('have new annotations to load');for(var b=0;b<a.length;b++){console.log('need to add something.');var c=a[b];console.log(c);K(c);}}}function O(){var b=$(a).data('easyannotation-file-id');if(localStorage.getItem(b)){var c=JSON.parse(localStorage.getItem(b));if(c==null)A=[];else A=c;}else A=[];$(a).controls=false;A.sort(function(a,b){return a.startTime-b.startTime;});Y();ac();}function P(){var b=JSON.stringify(A);var c=$(a).data('easyannotation-file-id');localStorage.setItem(c,b);}function Q(){window.localStorage.clear();A=[];console.log('Local storage cleared.');}function R(){$(e).fadeTo("fast",0);y=true;console.log('Starting to add annotation...');$(a).trigger('pause');$(i).text("Begin drawing over the video...");}function S(){u.clearRect(0,0,t.width,t.height);y=false;$(i).text("");ah();}function T(){var a=$(r).val();var b=$(s).val();$(e).fadeTo("fast",1);ah();$(r).val("");$(s).val("2");if(b==null||isNaN(b))b="2";if(B==true){var c=(w.startX/1.5);var d=(w.startY/1.5);var f=(w.w/1.5);var g=(w.h/1.5);}else{var c=w.startX;var d=w.startY;var f=w.w;var g=w.h;}if(g<20)g=20;if(f<30)f=30;if(c+f>390)c=390-f;if(d+g>210)d=210-g;if(a!=null&&a.length>0){var h=new H(a,null,c,d,f,g,z,(z+parseInt(b)),E);A.push(h);P();Y();E=E+1;}}function U(){ah();$(r).val("");$(s).val("2");$(e).fadeTo("fast",1);}function V(){if(b.paused||b.ended){b.play();$(g).html('<i class="fa fa-pause"></i>');}else{b.pause();$(g).html('<i class="fa fa-play"></i>');}}function W(a){var b=Math.floor(a/60);var c=a-(b*60);if(c<10)c="0"+String(c);if(a<10)return "0:0"+String(a);if(a<60)return "0:"+String(a);return String(b)+":"+String(c);}function X(){var a=document.getElementById('progress');var c=Math.floor((100/b.duration)*(b.currentTime));a.value=c;a.innerHTML=c+"%";}function Y(){A.sort(function(a,b){return a.startTime-b.startTime;});$("li.vidAnnotationListItem").each(function(a){this.remove();});for(var a=0;a<A.length;a++){var b=A[a];var c='<li class="vidAnnotationListItem"><a class="removeAnnotation" href="#" data-annotation-id="'+a+'">X</a><div class="vidAnnotationType">Text annotation</div><div class="vidAnnotationTimes">'+W(b.startTime)+' - '+W(b.endTime)+'</div><div class="vidAnnotationContent">'+b.textString+'</div></li>';$("ul#vidAnnotationList").append(c);}}function Z(a){var b=A[a];L(b);A.splice(a,1);Y();P();}function ab(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top};}function ac(){t.addEventListener('mousedown',ad,false);t.addEventListener('mouseup',ae,false);t.addEventListener('mousemove',af,false);}function ad(a){if(y){w.startX=ab(t,a).x;w.startY=ab(t,a).y;console.log(w);x=true;}}function ae(){if(!y)return;x=false;S();}function af(a){if(x&&y){console.log('pageX: '+a.pageX+' pageY: '+a.pageY);w.w=ab(t,a).x-w.startX;w.h=ab(t,a).y-w.startY;u.clearRect(0,0,t.width,t.height);ag();}}function ag(){if(y){u.fillStyle="rgba(89, 124, 86, 0.85)";u.fillRect(w.startX,w.startY,w.w,w.h);}}function ah(){if(C){$('#addAnnotationForm').hide();$('#vidTitle').css('margin-top','14px');C=false;}else{$('#addAnnotationForm').show();$('#vidTitle').css('margin-top','-150px');C=true;}}$(document).ready(function(){console.log('ready');O();$('#addAnnotationForm').hide();$(a).bind('play',function(){console.log('started playing.');M();$(g).html('<i class="fa fa-pause"></i>');});$(a).bind('pause',function(){console.log('playback paused.');$(g).html('<i class="fa fa-play"></i>');});$(a).bind('ended',function(){console.log('finished playing.');z=0;document.getElementById('progress').value=0;$(g).html('<i class="fa fa-play"></i>');$('div.annotation-on-screen').remove();});$(a).bind('timeupdate',function(){X();var a=Math.floor(this.currentTime);if(a!=z){console.log('seconds changed: '+a);z=a;M();}});$(e).click(function(){R();});$(p).click(function(){T();});$(q).click(function(){U();});$(g).click(function(){V();});$(document).on('click',f,function(){var a=$(this).data('annotation-id');Z(a);});$(k).click(function(){if(b.volume==1)return;b.volume+=0.1;});$(j).click(function(){if(b.volume==0)return;b.volume-=0.1;});$(m).click(function(){var a=confirm('This will delete ALL annotations for every video in easyAnnotate. Do you wish to continue?');if(a){Q();P();Y();$('div.annotation-on-screen').remove();}});$(l).click(function(){if(B){$(a).animate({"width":"400px"},function(){$(d).show();});$(this).text("Hide Annotation List");B=false;v=400;t.width=400;t.height=220;$('.annotation-on-screen').each(function(a,b){var c=$(this).width();var d=$(this).height();var e=$(this).position().left;var f=$(this).position().top;var g=c*0.666;var h=d*0.666;var i=e*0.666;var j=f*0.666;$(this).animate({width:g+'px',height:h+'px',left:i+'px',top:j+'px'});console.log('Annotation style adjusted for smaller video size.');});$("#addAnnotationForm").animate({"top":"330px"});}else{$(a).animate({"width":"600px"});$(d).hide();$(this).text("Show Annotation List");B=true;v=600;t.width=600;t.height=330;$('.annotation-on-screen').each(function(a,b){var c=$(this).width();var d=$(this).height();var e=$(this).position().left;var f=$(this).position().top;var g=c*1.5;var h=d*1.5;var i=e*1.5;var j=f*1.5;$(this).animate({width:g+'px',height:h+'px',left:i+'px',top:j+'px'});console.log('Annotation style adjusted for larger video size.');});$("#addAnnotationForm").animate({"top":"440px"});}});$(n).click(function(){if(D){D=false;$(this).text("Turn on annotations");$('div.annotation-on-screen').remove();}else{D=true;$(this).text("Turn off annotations");N();}});Mousetrap.bind('space',function(){$(g).trigger('click');});Mousetrap.bind('up',function(){$(k).trigger('click');});Mousetrap.bind('down',function(){$(j).trigger('click');});Mousetrap.bind('n',function(){R();});Mousetrap.bind('h',function(){$(l).trigger('click');});});