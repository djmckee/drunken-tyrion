var a='video';var b=document.getElementById('videoPlayer');var c='div#vid-overlay';var d='#vidAnnotation';var e='a#addAnnotation';var f='a.removeAnnotation';var g='a#playPauseButton';var h='progress#progress';var i='div#informationalText';var j='a#volume-down';var k='a#volume-up';var l='a#hidey-showy';var m='a#delete-everything-button';var n='a#toggle-annotations-button';var o='span#play-time';var p='#addAnnotationForm';var q='a#saveAddForm';var r='a#cancelAddForm';var s='#form-annotation-text';var t='#form-annotation-length';var u="#colour-button";var v="rgba(89, 124, 86, 0.7)";var w=document.getElementById('vid-canvas');var x=w.getContext('2d');var y=400;var z={};var A=false;var B=false;var C=0;var D=[];var E=false;var F=false;var G=true;var H=3000;function I(a,b,c,d,e,f,g,h,i,j){this.textString=a;this.imageUrl=b;this.xPosition=c;this.yPosition=d;this.aWidth=e;this.aHeight=f;this.startTime=g;this.endTime=h;this.zIndex=i;this.backgroundColour=j;}function J(a){var b=(String(a.startTime))+(String(a.endTime))+(String(a.xPosition))+(String(a.yPosition))+(a.text);var c=CryptoJS.MD5(b);return c.toString();}function K(a){var b=new I(a,null,30,30,30,30,3,5,3000,v);D.push(b);console.log(D);}function L(a){if(!G)return;var b=J(a);var d='<div class="annotation-on-screen" id="'+b+'"></div>';var e='div#'+b;$(c).append(d);console.log('attempting to add:'+d);var f=a.aHeight;if(f<20)f=20;var g=a.aWidth;if(g<30)g=30;var h=v;if(a.backgroundColour)h=a.backgroundColour;$(e).css({"width":(g*y/400),"height":(f*y/400),"position":"absolute","top":(a.yPosition*y/400),"left":(a.xPosition*y/400),"z-index":a.zIndex,"background-color":h});var i=a.textString;console.log('annotation title: '+i);if(i==null)i="";$(e).text(i);if(a.imageUrl!=null){var j='<img src="'+a.imageUrl+'"/>';$(e).append(j);var k=e+' img';$(k).css({"width":"100%","height":"auto"});}}function M(a){var b=J(a);var c='div#'+b;$(c).remove();}function N(){console.log('update called.');$(o).text(X(C));var a=$.grep(D,function(a){return(C>=a.startTime&&C<a.endTime);});var b=$.grep(D,function(a){return(C==a.startTime);});if(b!=null)if(b.length>0){console.log('have new annotations to load');for(var c=0;c<b.length;c++){console.log('need to add something.');var d=b[c];console.log(d);L(d);}}var e=$.grep(D,function(a){return(C==a.endTime);});if(e!=null)if(e.length>0){console.log('have old annotations to remove');for(var c=0;c<e.length;c++){console.log('need to remove something.');M(e[c]);}}console.log(a);}function O(){var a=$.grep(D,function(a){return(C>=a.startTime&&C<a.endTime);});if(a!=null)if(a.length>0){console.log('have new annotations to load');for(var b=0;b<a.length;b++){console.log('need to add something.');var c=a[b];console.log(c);L(c);}}}function P(){var b=$(a).data('easyannotation-file-id');if(localStorage.getItem(b)){var c=JSON.parse(localStorage.getItem(b));if(c==null)D=[];else D=c;}else D=[];$(a).controls=false;D.sort(function(a,b){return a.startTime-b.startTime;});Z();ad();}function Q(){var b=JSON.stringify(D);var c=$(a).data('easyannotation-file-id');localStorage.setItem(c,b);}function R(){window.localStorage.clear();D=[];console.log('Local storage cleared.');}function S(){$(e).fadeTo("fast",0);B=true;console.log('Starting to add annotation...');$(a).trigger('pause');$(i).text("Begin drawing over the video...");}function T(){x.clearRect(0,0,w.width,w.height);B=false;$(i).text("");ai();}function U(){var a=$(s).val();if(a==null||a.length<1){alert("An annotation title is required - please enter one.");return;}var b=$(t).val();$(e).fadeTo("fast",1);ai();$(s).val("");$(t).val("2");if(b==null||isNaN(b))b="2";if(E==true){var c=(z.startX/1.5);var d=(z.startY/1.5);var f=(z.w/1.5);var g=(z.h/1.5);}else{var c=z.startX;var d=z.startY;var f=z.w;var g=z.h;}if(g<20)g=20;if(f<30)f=30;if(c+f>390)c=390-f;if(d+g>210)d=210-g;var h=$(u).css("background-color");if(a!=null&&a.length>0){var i=new I(a,null,c,d,f,g,C,(C+parseInt(b)),H,h);D.push(i);Q();Z();H=H+1;}}function V(){ai();$(s).val("");$(t).val("2");$(e).fadeTo("fast",1);}function W(){if(b.paused||b.ended){b.play();$(g).html('<i class="fa fa-pause"></i>');}else{b.pause();$(g).html('<i class="fa fa-play"></i>');}}function X(a){var b=Math.floor(a/60);var c=a-(b*60);if(c<10)c="0"+String(c);if(a<10)return "0:0"+String(a);if(a<60)return "0:"+String(a);return String(b)+":"+String(c);}function Y(){var a=document.getElementById('progress');var c=Math.floor((100/b.duration)*(b.currentTime));a.value=c;a.innerHTML=c+"%";}function Z(){D.sort(function(a,b){return a.startTime-b.startTime;});$("li.vidAnnotationListItem").each(function(a){this.remove();});for(var a=0;a<D.length;a++){var b=D[a];var c='<li class="vidAnnotationListItem"><a class="removeAnnotation" href="#" data-annotation-id="'+a+'">X</a><div class="vidAnnotationType">Text annotation</div><div class="vidAnnotationTimes">'+X(b.startTime)+' - '+X(b.endTime)+'</div><div class="vidAnnotationContent">'+b.textString+'</div></li>';$("ul#vidAnnotationList").append(c);}}function ab(a){var b=D[a];M(b);D.splice(a,1);Z();Q();}function ac(a,b){var c=a.getBoundingClientRect();return{x:b.clientX-c.left,y:b.clientY-c.top};}function ad(){w.addEventListener('mousedown',ae,false);w.addEventListener('mouseup',af,false);w.addEventListener('mousemove',ag,false);}function ae(a){if(B){z.startX=ac(w,a).x;z.startY=ac(w,a).y;console.log(z);A=true;}}function af(){if(!B)return;A=false;T();}function ag(a){if(A&&B){console.log('pageX: '+a.pageX+' pageY: '+a.pageY);z.w=ac(w,a).x-z.startX;z.h=ac(w,a).y-z.startY;x.clearRect(0,0,w.width,w.height);ah();}}function ah(){if(B){x.fillStyle="rgba(89, 124, 86, 0.85)";x.fillRect(z.startX,z.startY,z.w,z.h);}}function ai(){if(F){$(p).hide();$('#vidTitle').css('margin-top','14px');F=false;}else{$(p).show();$('#vidTitle').css('margin-top','-200px');$(u).attr('value',v);$(u).colorPicker();F=true;}}$(document).ready(function(){console.log('ready');P();$(p).hide();$(a).bind('play',function(){console.log('started playing.');N();$(g).html('<i class="fa fa-pause"></i>');});$(a).bind('pause',function(){console.log('playback paused.');$(g).html('<i class="fa fa-play"></i>');});$(a).bind('ended',function(){console.log('finished playing.');C=0;document.getElementById('progress').value=0;$(g).html('<i class="fa fa-play"></i>');$('div.annotation-on-screen').remove();});$(a).bind('timeupdate',function(){Y();var a=Math.floor(this.currentTime);if(a!=C){console.log('seconds changed: '+a);C=a;N();}});$(e).click(function(){S();});$(q).click(function(){U();});$(r).click(function(){V();});$(g).click(function(){W();});$(document).on('click',f,function(){var a=$(this).data('annotation-id');ab(a);});$(k).click(function(){if(b.volume==1)return;b.volume+=0.1;});$(j).click(function(){if(b.volume==0)return;b.volume-=0.1;});$(m).click(function(){var a=confirm('This will delete ALL annotations for every video in easyAnnotate. Do you wish to continue?');if(a){R();Q();Z();$('div.annotation-on-screen').remove();}});$(l).click(function(){if(E){$(a).animate({"width":"400px"},function(){$(d).show();});$(this).text("Hide Annotation List");E=false;y=400;w.width=400;w.height=220;var b=0.666;$('.annotation-on-screen').each(function(a,c){var d=$(this).width();var e=$(this).height();var f=$(this).position().left;var g=$(this).position().top;var h=d*b;var i=e*b;var j=f*b;var k=g*b;$(this).animate({width:h+'px',height:i+'px',left:j+'px',top:k+'px'});console.log('Annotation style adjusted for smaller video size.');});$(p).animate({"top":"330px"});}else{$(a).animate({"width":"600px"});$(d).hide();$(this).text("Show Annotation List");E=true;y=600;w.width=600;w.height=330;var c=1.5;$('.annotation-on-screen').each(function(a,b){var d=$(this).width();var e=$(this).height();var f=$(this).position().left;var g=$(this).position().top;var h=d*c;var i=e*c;var j=f*c;var k=g*c;$(this).animate({width:h+'px',height:i+'px',left:j+'px',top:k+'px'});console.log('Annotation style adjusted for larger video size.');});$(p).animate({"top":"440px"});}});$(n).click(function(){if(G){G=false;$(this).text("Turn on annotations");$('div.annotation-on-screen').remove();}else{G=true;$(this).text("Turn off annotations");O();}});Mousetrap.bind('space',function(){$(g).trigger('click');});Mousetrap.bind('up',function(){$(k).trigger('click');});Mousetrap.bind('down',function(){$(j).trigger('click');});Mousetrap.bind('n',function(){S();});Mousetrap.bind('h',function(){$(l).trigger('click');});});